{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen py-6 sm:py-8">
    <!-- Back Button -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <a href="{% url 'stray' %}" class="inline-block text-gray-600 hover:text-black text-sm sm:text-base font-medium transition-colors duration-300 ease-in-out">
            ← ย้อนกลับ
        </a>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 mt-4 sm:mt-6">
        <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 space-y-6 sm:space-y-8">
            <!-- Title -->
            <h2 class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-center text-gray-800">รายละเอียดสัตว์</h2>

            <!-- Animal Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 ">
                <!-- Image -->
                <div class="flex justify-center">
                    <img src="{{ animal.image.url }}" alt="{{ animal.name }}" class="w-full max-w-md h-min-[80%] rounded-lg shadow-md object-cover">
                </div>
                
                <!-- Info -->
                <div class="space-y-3 sm:space-y-4">
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">ชนิด:</span> {{ animal.get_species_display  }}</p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">ชื่อ:</span> {{ animal.name }}</p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">เพศ:</span> {{ animal.get_gender_display  }}</p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">อายุ:</span> {{ animal.age }} </p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">สี:</span> {{ animal.color }}</p>
                    <p class="text-sm sm:text-base whitespace-normal break-words"><span class="font-bold text-gray-800">ข้อมูลสัตว์เพิ่มเติม:</span> {{ animal.description }}</p>
                    <p class="text-sm sm:text-base whitespace-normal break-words"><span class="font-bold text-gray-800">ข้อมูลสถานที่เพิ่มเติม:</span> {{ stray_animal.description_location }}</p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">วันที่พบ:</span> {{ stray_animal.date_found|date:"d M Y" }}</p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">ผู้พบเห็น:</span> {{ stray_animal.reported_by }} </p>
                    <p class="text-sm sm:text-base"><span class="font-bold text-gray-800">เบอร์ติดต่อ: </span> {{profile.phone_number}}</p>
                    
                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2">
                        <span class="font-bold text-gray-800 text-sm sm:text-base">แท็ก:</span>
                        {% for t in tag %}
                            <span class="px-3 py-1 bg-blue-100 text-blue-600 text-sm rounded-lg shadow-sm">{{ t.name }}</span>
                        {% empty %}
                            <span class="text-gray-400 text-sm sm:text-base">ไม่มีแท็ก</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="py-4 sm:py-6">
                <h3 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">ตำแหน่งสัตว์</h3>
                <div id="map" class="w-full h-[300px] sm:h-[400px] lg:h-[500px] rounded-2xl shadow-lg"></div>
            </div>

            <!-- Comments Section -->
            <div class="space-y-4 sm:space-y-6">
                <h3 class="text-xl sm:text-2xl font-semibold text-gray-800">ความคิดเห็น</h3>

                <!-- Show Comments -->
                <div class="space-y-3 sm:space-y-4">
                    {% for comment in comments %}
                        <div class="border border-gray-200 rounded-lg p-4 sm:p-5 shadow-sm bg-gray-50 hover:bg-gray-100 transition-colors duration-300">
                            <p class="text-gray-700 text-sm sm:text-base">{{ comment.comment_text }}</p>
                            <div class="text-xs sm:text-sm text-gray-500 flex flex-col sm:flex-row justify-between mt-2">
                                <span>โดย {{ comment.comment_by.username }}</span>
                                <span>{{ comment.comment_date|date:"d M Y H:i" }}</span>
                            </div>
                            {% if perms.animaltracking.delete_comment %}
                            <form method="post" action="{% url 'delete_comment_stray' comment.id %}" class="mt-2 text-right">
                                {% csrf_token %}
                                <button type="submit" class="hover:bg-red-500 bg-red-400 text-white font-medium px-3 py-1 rounded-lg transition text-xs sm:text-sm">
                                    ลบความคิดเห็น
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-gray-400 text-sm sm:text-base">ยังไม่มีความคิดเห็น</p>
                    {% endfor %}
                </div>
                {% if form_animal.non_field_errors %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
                        {% for error in form_animal.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <!-- Add Comment -->
                <div class="mt-4 sm:mt-6">
                    <form method="post" class="space-y-3">
                        {% csrf_token %}
                        <label for="{{ form_comment.comment_text.id_for_label }}" class="block font-medium text-gray-700 text-sm sm:text-base mb-2">แสดงความคิดเห็น</label>
                        {{ form_comment.comment_text|add_class:"w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 transition min-h-[100px] text-sm sm:text-base" }}
                        {{ form_comment.comment_text.errors }}
                        <button type="submit" class="mt-3 px-4 sm:px-6 py-2 sm:py-3 bg-[#8FD19E] text-white rounded-full font-semibold shadow-md hover:bg-[#76c285] transition-colors duration-300 text-sm sm:text-base">
                            ส่งความคิดเห็น
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
           var map = L.map('map').setView([13.736717, 100.523186], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var animals = JSON.parse('{{ data|escapejs }}');
            console.log(animals);

            animals.forEach(function(item, index) {
                var marker = L.marker([item.lat, item.long]).addTo(map);
                let popupContent = `
                <b>${item.animal_name}</b>`;
            
                marker.bindPopup(popupContent);
                marker.openPopup();
                map.setView([item.lat, item.long], 12);

            });
        });
    </script>

{% endblock %}