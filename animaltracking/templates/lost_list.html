{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="min-h-screen py-6 sm:py-8">
        <!-- Back Button -->
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <a href="{% url 'home' %}" class="inline-block text-gray-600 hover:text-black text-sm sm:text-base font-medium transition-colors duration-300 ease-in-out">
                ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </a>
        </div>

        <!-- Main  -->
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 mt-4 sm:mt-6">
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 space-y-6 sm:space-y-8">
                <!-- Header-->
                <section class="flex flex-col sm:flex-row items-center justify-between">
                    <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-800 mb-4 sm:mb-0">‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏≤‡∏¢</h1>
                    {% if perms.animaltracking.add_strayanimal %}
                        <a href="{% url 'lost_create' %}" class="bg-white text-gray-800 px-4 py-2 sm:px-6 sm:py-3 rounded-full font-semibold shadow-md hover:bg-gray-100 border border-gray-300 transition-colors duration-300 ease-in-out">
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏≤‡∏¢
                        </a>
                    {% endif %}
                </section>

                <!-- Map Section -->
                <section>
                    <h3 class="text-lg sm:text-xl lg:text-2xl font-semibold text-gray-800 mb-4">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢</h3>
                    <div id="map" class="w-full h-[250px] sm:h-[400px] lg:h-[500px] rounded-2xl shadow-lg"></div>
                </section>

                <!-- Stray Animals Grid Section -->
                <section>
                    <h3 class="text-xl sm:text-2xl lg:text-3xl font-semibold text-gray-800 mb-6">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    
                    <!-- Filter -->
                    <div class="bg-gray-50 bg-opacity-50 rounded-lg p-4 mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
                            <label class="font-semibold text-gray-700 text-sm sm:text-base">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°:</label>
                            <div class="flex flex-wrap gap-3">
                                <select id="filter-species" class="border border-gray-300 rounded-lg px-3 py-2 bg-white text-gray-700 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-gray-300 transition">
                                    <option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡∏ô‡∏¥‡∏î</option>
                                    <option value="dog">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
                                    <option value="cat">‡πÅ‡∏°‡∏ß</option>
                                    <option value="bird">‡∏ô‡∏Å</option>
                                    <option value="rabbit">‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢</option>
                                    <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                </select>
                                <select id="filter-gender" class="border border-gray-300 rounded-lg px-3 py-2 bg-white text-gray-700 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-gray-300 transition">
                                    <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®</option>
                                    <option value="male">‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ</option>
                                    <option value="female">‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="animal-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-5 sm:gap-6 mt-6">
                        {% for animal in lost_animals %}
                        <div class="animal-card bg-white rounded-2xl shadow-md border border-gray-200 hover:shadow-xl hover:scale-[1.01] transition-all duration-300 cursor-pointer"
                            data-species="{{ animal.animal.species|lower }}" data-gender="{{ animal.animal.gender|lower }}">

                            <!-- ‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ï‡∏ß‡πå -->
                            <a href="{% url 'lost_comment' animal.id %}" class="block">
                                <div class="relative">
                                    <img src="{{ animal.animal.image.url }}" alt="{{ animal.animal.name }}"
                                        class="w-40 h-40 sm:w-44 sm:h-44 object-cover rounded-full mx-auto mt-6 border-4 border-yellow-200 shadow-inner">
                                    <div class="absolute top-2 right-2 bg-white/80 backdrop-blur-sm px-2 py-1 rounded-full text-xs text-gray-700 shadow">
                                        üêæ {{ animal.animal.get_species_display }}
                                    </div>
                                </div>

                                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                                <div class="p-5 ">
                                    <h4 class="font-semibold text-lg text-gray-800 mb-2 text-center">{{ animal.animal.name }}</h4>
                                    <div class="space-y-1 text-sm text-gray-600">
                                        <p><span class="font-medium text-gray-700">‡πÄ‡∏û‡∏®:</span> {{ animal.animal.get_gender_display }}</p>
                                        <p><span class="font-medium text-gray-700">‡∏≠‡∏≤‡∏¢‡∏∏:</span> {{ animal.animal.age }}</p>
                                        <p><span class="font-medium text-gray-700">‡∏™‡∏µ:</span> {{ animal.animal.color }}</p>
                                        <p><span class="font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> {{ animal.get_status_display }}</p>
                                    </div>
                                </div>
                            </a>

                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ -->
                            <div class="flex items-center justify-center gap-1.5 p-3 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
                                <a href="{% url 'lost_comment' animal.id %}"
                                class="inline-flex items-center justify-center gap-1 bg-yellow-400 hover:bg-yellow-500 text-gray-800 text-sm font-medium px-3 py-1.5 rounded-md shadow-sm transition-all duration-200 whitespace-nowrap">
                                    ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
                                </a>

                                {% if perms.animaltracking.change_lostanimal %}
                                <a href="{% url 'lost_edit' animal.id %}"
                                class="inline-flex items-center justify-center gap-1 bg-blue-400 hover:bg-blue-500 text-white text-sm font-medium px-3 py-1.5 rounded-md shadow-sm transition-all duration-200 whitespace-nowrap">
                                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </a>
                                {% endif %}

                                {% if perms.animaltracking.delete_lostanimal %}
                                <form method="post" action="{% url 'delete_lost' animal.id %}" class="inline-block">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="inline-flex items-center justify-center gap-1 bg-red-400 hover:bg-red-500 text-white text-sm font-medium px-3 py-1.5 rounded-md shadow-sm transition-all duration-200 whitespace-nowrap">
                                        ‡∏•‡∏ö
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                </section>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>

        
        document.addEventListener("DOMContentLoaded", function () {
            var map = L.map("map").setView([13.736717, 100.523186], 6);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors",
            }).addTo(map);

            // Data 
            var animals = JSON.parse('{{ data|escapejs }}');
            console.log(animals);

            // ‡πÄ‡∏Å‡πá‡∏ö markers ‡πÄ‡∏û‡∏∑‡πà‡∏≠ filter ‡πÑ‡∏î‡πâ
            var markers = [];

            animals.forEach((item, index) => {
                let marker = L.marker([item.lat, item.long]).addTo(map);

                let popupContent = `
                <b>${item.animal_name}</b> (${item.species})<br/>
                <span class="text-gray-500">${item.type.toUpperCase()}</span><br/>
                <a href="${item.url}" target="_blank">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>`;

                if (item.status) {
                    popupContent += `<br/><span>Status: ${item.status}</span>`;
                }

                marker.bindPopup(popupContent);

            });
        });

        // --- Filter function ---
        const filterSpecies = document.getElementById("filter-species");
        const filterGender = document.getElementById("filter-gender");
        const cards = document.querySelectorAll(".animal-card");

        function applyFilters() {
            const speciesValue = filterSpecies.value;
            const genderValue = filterGender.value;

            // Filter cards
            cards.forEach(card => {
                const species = card.dataset.species;
                const gender = card.dataset.gender;

                let showCard =
                (speciesValue === "all" || speciesValue === species) && (genderValue === "all" || genderValue === gender);

                card.style.display = showCard ? "block" : "none";
            });
        }

        filterSpecies.addEventListener("change", applyFilters);
        filterGender.addEventListener("change", applyFilters);

    </script>
{% endblock %}